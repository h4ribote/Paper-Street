# Economy & Market System

## 1. 経済システム（リアリティ重視）
Paper Streetでは、実際の金融理論に基づいた高度な経済モデルを実装しつつ、ゲームとしてのバランスを維持するための独自メカニズムを導入します。

### 1.1. 高度な市場シミュレーション
*   **24時間市場 (24/7 Market)**: 株式、債券、FXを含むすべての資産クラスが、24時間365日取引可能です。
*   **Order Book (板情報) システム**: 株式や債券ではBuy/Sellの注文状況（板）を可視化。プレイヤーの注文が板に並び、実際に市場価格に影響を与えます。FX市場では**流動性プール (Liquidity Pools)** を採用し、板取引ではなくプールとの直接取引を行います。
*   **流動性 (Liquidity)**: 取引量が少ない銘柄ではスプレッドが広がり、大量注文が価格を大きく動かす（Market Impact）リスクを再現します。
*   **マクロ経済指標**: 金利（政策金利）、インフレ率（CPI）、GDP、失業率などの指標が定期的に発表され、すべての資産クラスに相関的な影響を与えます。詳細は [Macro Economic Indicators](./MACRO_ECONOMICS.md) を参照してください。
*   **相関マトリクス**: 「金利上昇→債券価格下落」「原油高→航空株下落」といった資産間のリアルな相関関係をシミュレートします。

### 1.2. 市場の健全性維持 (Market Integrity)
特定のプレイヤーグループによる相場操縦（Pump & Dump）を防ぐための措置を講じます。

*   **流動性ティア (Liquidity Tiers)**: 流動性の低い銘柄（Small Cap）に対しては、スプレッドを強制的に広げることで、操縦コストを引き上げます。
*   **Botの「異常検知」ロジック**: 急激な価格上昇に対し、追随するのではなく「警戒（売り向かう）」するAIロジックを導入し、安易な釣り上げを阻止します。
*   **成行注文の保護 (Market Order Protection)**: フラッシュクラッシュ（瞬間的な暴落）や流動性の枯渇を防ぐため、成行注文には以下の保護措置が適用されます。
    *   **価格ガード (Price Guard)**: 最良気配値の **±5%** を超える価格での約定を禁止します。
    *   **部分キャンセル**: ガード価格を超える注文残数量は即座に無効化されます。
    *   **連続発注制限**: 成行注文後の5秒間は、同方向への成行注文を制限し、市場が価格変動を消化する時間（Cool-down）を与えます。

### 1.3. 初期経済バランス (Initial Economic Balance)
ゲーム開始時（Day 1）の総資産供給量や、プレイヤー、国家、企業、ボットへの資産配分については、[Initial Asset Allocation](./INITIAL_ASSET_ALLOCATION.md) を参照してください。


## 2. 資産クラス (Asset Classes)
*   **Stocks**: セクター分類（Tech, Energy, Finance等）と、ファンダメンタルズ（PER, EPS）に基づく価格形成。
*   **Bonds (Perpetual Consols)**:
    Paper Streetでは、すべての国債を「満期のない永久債（Consols）」として扱います。
    *   **特徴**: 満期日も元本償還も存在しません。保有している限り、永久に定額の利息（Coupon）を受け取り続けることができます。
    *   **価格変動**: 満期がないため、市場価格は「金利変動」の影響を極めて大きく受けます（高いデュレーション）。
        *   金利上昇（利上げ）→ 価格暴落
        *   金利低下（利下げ）→ 価格暴騰

    #### 2.0.1. 価格決定メカニズム (Pricing Mechanism)
    システムが強制的に価格を決めるのではなく、プレイヤーとボットの「板取引（需給）」によって価格が形成されますが、その理論的なベースとなるのは以下の計算式です。
    *   **理論価格 (P) = 固定利息 (C) / 現在の市場金利 (r)**

    **【価格変動のダイナミクス】**
    *   Arcadiaの市場金利が **2.5%** の時、ARCBの理論価格は `2.50 / 0.025 = 100 ARC` となります。
    *   インフレ懸念により、Arcadia中央銀行が政策金利を **5.0%** に引き上げた（利上げ）場合、理論価格は `2.50 / 0.050 = 50 ARC` に半減（暴落）します。
    *   逆に、金利を **1.25%** に引き下げた（利下げ）場合、理論価格は `2.50 / 0.0125 = 200 ARC` に倍増（暴騰）します。

    #### 2.0.2. 発行と流通のフロー (Primary & Secondary Market)
    専用の発行UIを持たず、すべて「ニュース」と「板取引」で完結させます。

    *   **新規発行（売りオペ / 資金吸収）**:
        1.  ニュース配信: `[MACRO] Arcadia Central Bank to issue 1,000,000 units of Consol Bonds to curb inflation.`
        2.  中央銀行AIが「ARCB」の板に対し、**目標とする利回りに合致する価格（例: 98.00 ARC）で巨大な「売り指値注文」を配置**します（売り壁）。
        3.  プレイヤーやボットが売り壁を買うことで、市場から現金が吸収されます。

    *   **買い戻し・消却（買いオペ / 資金供給）**:
        1.  ニュース配信: `[MACRO] Arcadia announces Quantitative Easing, buying back Consol Bonds.`
        2.  中央銀行AIが、市場の売り板に出ているARCBを、**目標価格（例: 105.00 ARC）まで買い上げていきます**。
        3.  買い戻した国債は消却され、プレイヤーに現金が供給されます。

    #### 2.0.3. 利払いフロー (Coupon Payment Batch)
    *   **実行タイミング**: 毎週（Day 7, 14, 21...）の 00:00 など。
    *   **権利確定**: 「加重平均取得日時から一定時間（例: 72時間）経過していること」を条件とします（Dividend Stripping対策）。
    *   **処理**: `支払額 = 保有数量 × Base Coupon` を計算し、現金（ARCなど）を振り込みます。

*   **Forex**: 為替変動を利用した取引。**Uniswap V3形式の集中流動性 (Concentrated Liquidity)** を採用したAMMを使用し、基軸通貨である**ARC**と各通貨のペア（例: VDP/ARC, BRB/ARC）で取引されます。
    *   **詳細設計**: 具体的な数学モデル、手数料体系、最適化ロジックについては **[FX Market Model](./FX_MARKET_MODEL.md)** を参照してください。
    *   **理論為替レート (Theoretical FX Rate)**:
        マクロ経済指標（GDP成長率、金利、インフレ率）に基づき算出される「適正価格」です。
        Bot（Arbitrageurs, National AI）はこのレートを基準にトレードを行い、市場価格との乖離を埋めようとします。
        詳細は **[Theoretical FX Rate Calculation](./THEORETICAL_FX_RATE.md)** を参照してください。
    *   **Algorithm**: **Tickごとの流動性計算 (Tick-based Liquidity)** を行うモデルを採用。従来の定数積モデル ($x \times y = k$) とは異なり、特定の価格帯（Tick）に流動性を集中させることで、資本効率の高い取引を実現します。
    *   **手数料体系**: **0.04%** (Low) と **0.20%** (Standard) の2つのFee Tierを提供します。
    *   **ARC基軸とRouter**: すべての通貨ペアはARCを介して行われます。システム（Router）は手数料や流動性を考慮し、最適なパス（Direct, Split, Multi-hop）を自動的に計算します。
    *   **流動性提供**: プレイヤーは**任意の価格範囲 (Range Order)** を指定して流動性を提供（Mint）し、その範囲内で取引が発生した場合に手数料収入を得ることができます。
*   **Derivatives**: オプションや先物など。

### 2.1. 信用取引メカニズム (Credit Trading)
単純な注文とは異なり、信用取引にはコストと制限が伴います。

*   **金利メカニズム**:
    在庫連動型の変動金利システムを採用しています。詳細は [Dual Liquidity Inventory System (DLI)](./DUAL_LIQUIDITY_INVENTORY.md) を参照してください。
    *   **金利/貸出手数料**: 信用取引に対して、在庫状況に応じた高い金利を課します。
    *   **在庫制限**: 各銘柄に「信用取引可能枠」を設定し、上限に達したら新規の信用取引を禁止します。

*   **リスク管理 (Isolation)**:
    Paper Streetでは、**「分離マージン (Isolated Margin)」** モデルを採用しています。
    各ポジションのリスクは独立しており、1つのポジションの損失がウォレット内の他の資金に波及することはありません。
    ロスカットのルールや証拠金計算の詳細は、[Isolated Margin Model](./ISOLATED_MARGIN_MODEL.md) を参照してください。


## 3. 手数料体系 (Fees)
取引手数料および信用取引の金利は、プレイヤーの **Trader Rank (トレーダーランク)** によって決定されます。
上位ランクほど、Maker/Taker手数料が削減され、金利優遇（Interest Discount）が適用されます。

詳細なランク定義とレートについては、[Trader Rank & Progression System](./TRADER_RANK_SYSTEM.md) を参照してください。

### 3.1. 取引手数料の徴収メカニズム (Trading Fee Mechanism)
板取引（Order Book Trading）における手数料は、以下のルールで徴収されます。

*   **決済通貨建て**: 手数料は常に取引の対価となる通貨（Quote Currency）で支払われます。
*   **買い注文 (Buy Order)**:
    *   約定代金に手数料が**加算**され、ウォレットから引き落とされます。
    *   `支払額 = (約定価格 × 数量) + 手数料`
    *   残高不足の場合、注文は拒否されます。
*   **売り注文 (Sell Order)**:
    *   約定代金から手数料が**天引き**され、残額がウォレットに入金されます。
    *   `受取額 = (約定価格 × 数量) - 手数料`

### 3.2. 保険基金 (Insurance Fund)
徴収された取引手数料は、運営の収益ではなく、市場の安定化を図るための「保険基金（Insurance Fund）」に蓄積されます。

*   **目的**: 信用取引において、急激な価格変動によりユーザーの証拠金がマイナス（債務超過）となった場合、その損失分をシステムが補填するために使用されます（ロスカット補償）。
*   **資金源**: 板取引のMaker/Taker手数料、およびロスカット時の清算手数料の一部。
*   **枯渇時の対応**: 万が一、保険基金が枯渇した場合は、カウンターパーティ・リスク（ADL: Auto-Deleveraging）が発生する可能性があります。


## 4. シーズン制 (Seasonal System)
MMOとしての長期的なモチベーション維持と、経済のリセットのためにシーズン制（**60日固定**）を導入します。

### 4.1. シーズンサイクル
1シーズンを1会計年度（Fiscal Year）とし、以下のスケジュールで進行します。

*   **Q1**: Day 1 ～ Day 14
*   **Q2**: Day 15 ～ Day 28
*   **Q3**: Day 29 ～ Day 42
*   **Q4**: Day 43 ～ Day 56（決算＋シーズンクライマックス）
*   **End**: Day 57 ～ 60（最終ランキング集計・報酬付与）

*   **リセット**: シーズン終了時に全プレイヤーの資産とポジションはリセットされます。
*   **ランキング**: 「総資産額」「最大瞬間ROI」などでランキングを決定し、勝者を称えます。
*   **報酬**:
    *   **称号 (Titles)**: "Wolf of Paper Street", "Market Wizard" など。
    *   **Boost**: ランクとランキングの実績に応じて、次シーズンの初期XPにボーナスが付与され、有利な条件（Rank引継ぎ）で開始できます。詳細は [Trader Rank & Progression System](./TRADER_RANK_SYSTEM.md) を参照してください。

### 4.2. シーズンテーマ (Dynamic Meta)
シーズンごとに市場の「ルール」や「トレンド」が変化します。
*   **The Great Depression**: 全体的に弱気相場。空売りのスキルが試される。
*   **Tech Bubble**: テック株のボラティリティが極端に高い。
*   **Hyperinflation**: 現金の価値が下がるため、常にポジション（実物資産）を持っておく必要がある。


## 5. 企業の経済活動 (Corporate Economic Activity)
企業は単なる取引対象（銘柄）ではなく、独自の経済活動を行う主体として振る舞います。企業の業績は、市場価格や経済指標に動的に影響を受け、それが株価へとフィードバックされます。

### 5.1. 事業サイクルと決算 (Business Cycle & Earnings)
各企業は**14日（2週間）**を1つの決算期（Quarter）として活動します。このサイクルの中で、予測の発表と確定情報の公開、そして**配当**が行われます。

*   **目標利回り (Target Yield)**: 1回の配当で株価の **2% ～ 5%**（シーズン通算 8% ～ 20%）。インカムゲイン狙いの戦略が成立するよう調整されています。
*   **UI表示**: 誤解を招く「年利 (APY)」は使用せず、**「今期利回り (Yield/Q)」** や **「予想配当額 (Est. Div)」** と表示します。

#### Day 0-14: 経済活動 (Operations)
*   **原材料の調達 (Procurement)**: 製造業などの企業は、市場価格で原材料を購入します。原材料価格の変動は、即座に製造コスト（COGS）に反映されます。
*   **製造と販売 (Production & Sales)**: 調達した資源をもとに商品を製造し、市場需要（マクロ経済指標やAIの消費動向に依存）に応じて販売し、売上（Revenue）を計上します。

#### Day 7: 中間予測発表 (Earnings Guidance)
*   **収益予測 (Guidance)**: 決算期の折り返し地点で、現在の進捗に基づいた「収益予測」と「配当予測（Dividend Forecast）」を発表します。
*   **相場への影響**: 投資家（プレイヤーおよびAI）はこの予測を織り込み、期待値に基づいて売買を行います。好調な予測は株価上昇を、不調な予測は下落を招きます。

#### Day 14: 決算発表 & 権利確定 (Earnings Release & Ex-Dividend)
*   **決算確定 (Actuals)**: 最終的な「売上高」「純利益」「EPS（1株当たり利益）」および「確定配当」を発表します。
*   **配当決定ロジック (Dividend Calculation)**:
    配当額は、純利益と企業の「配当性向（Payout Ratio）」に基づいて決定されます。
    
    $$Dividend\ per\ Share = \frac{Net\ Income \times Payout\ Ratio}{Total\ Shares\ Outstanding}$$

    *   **配当性向 (Payout Ratio) の動的決定ロジック**:
        配当性向は固定値ではなく、企業の財務健全性と「サプライズ」に基づいて毎期変動します。

        $$Payout\ Ratio = Target\ Ratio + \alpha \times Surprise\ Factor + \beta \times Reserve\ Buffer$$

        *   **Target Ratio (目標性向)**: セクターごとに設定された基準値。
            *   **成熟企業 (Utility, Finance)**: 50% (0.50)
            *   **成長企業 (Tech, Biotech)**: 10% (0.10)
        *   **Surprise Factor (業績連動係数)**:
            *   計算式: `(Actual_EPS - Guidance_EPS) / Guidance_EPS`
            *   予想を上回る利益が出た場合、その余剰分の一部を株主に還元します ($\alpha \approx 0.5$)。
        *   **Reserve Buffer (内部留保調整)**:
            *   企業の現金保有量が「運転資金のX倍」を超えている場合、自社株買いや増配を行いやすくなります ($\beta \approx 0.2$)。
            *   逆に現金不足時は、黒字でも無配に転落するリスクがあります。

*   **権利確定 (Eligibility)**:
    Day 14の終了時（23:59 UTC）に株式を保有しており、かつ**加重平均取得日時（Weighted Average Acquisition Time）から3日（72時間）以上経過している**プレイヤーに配当権が付与されます。
    *   **判定メカニズム**:
        *   加重平均取得日時（Weighted Average Acquisition Time）を使用します。
        *   `(現在時刻 - 加重平均取得日時) >= 72時間` の条件を満たす必要があります。
        *   この条件を満たさない場合、配当は支払われません（Dividend Stripping対策）。
*   **配当の支払い**: 条件を満たすプレイヤーに対して、Day 15の00:00に支払われます。
*   **権利落ち (Drop)**: 理論上、Day 15の開始時に株価は配当分だけ下落します。
*   **サプライズ (Earnings Surprise)**: 「確定値」とDay 7の「予測値」、および市場のコンセンサス（期待値）との乖離が重要です。
    *   **Positive Surprise**: 予測を上回る好決算 → 株価急騰
    *   **Negative Surprise**: 予測を下回る決算 → 株価急落
    *   **織り込み済み (Priced In)**: 予測通りの結果であれば、材料出尽くしで逆に動くこともあります。

#### 保有期間と配当権利 (Holding Period & Dividend Eligibility)
プレイヤーの長期投資を推奨するため、保有期間に応じた配当利回りのボーナスを付与します。また、短期売買による配当狙い（Dividend Stripping）を防ぐための制限があります。

*   **保有期間の計算 (Calculation)**: 加重平均取得日時（Weighted Average Acquisition Time）を使用します。
    *   **計算式**: `(現在の数量 × 現在の平均取得日時 + 購入数量 × 現在時刻) / (現在の数量 + 購入数量)`
    *   **売却時**: 平均取得日時は変化しません（FIFO/LIFOではなく、残存する全株式の平均取得時刻が維持されるとみなします）。
    *   **判定**: この計算された日時と現在時刻の差分が「保有期間」となります。

*   **配当受取要件とボーナス階層**:
    *   **< 3日 (72時間)**: **配当なし (Ineligible)**
    *   **3日 ～ 14日**: ボーナスなし (Base Yield)
    *   **14日 ～ 28日**: +10% Bonus
    *   **28日 ～ 42日**: +20% Bonus
    *   **> 42日**: +30% Bonus (Max)

### 5.2. サプライチェーン連動 (Supply Chain Dynamics)
企業間には「川上（Upstream）」から「川下（Downstream）」へのサプライチェーンが存在し、収益構造が連動しています。

*   **原材料セクター（川上）**: 鉱業、農業、エネルギーなど。資源価格の上昇が直接的な増益要因となります。
*   **製造・サービスセクター（川下）**: テック、自動車、食品加工など。原材料セクターの生産物を「コスト」として消費します。
    *   **コストプッシュ・インフレ**: 原材料価格が高騰すると、川下企業の調達コストが圧迫され、利益率（Margin）が低下します。これにより、資源高の局面では「資源株買い・製造株売り」のトレンドが発生しやすくなります。
    *   **価格転嫁**: 強いブランド力を持つ企業（Tech Utopiaのトップ企業など）は、コスト増を製品価格に転嫁（値上げ）することで利益を維持できる場合がありますが、需要減退のリスクも伴います。

### 5.3. 詳細な経済メカニズム (Advanced Economic Mechanics)
企業の業績決定プロセスをより深く、分析可能にするために、以下の高度なメカニズムを導入しています。
詳細は [Economic Simulation Details](./ECONOMIC_SIMULATION_DETAILS.md) を参照してください。

*   **生産能力と設備投資 (Capacity & CapEx)**: 最大生産量の限界と、それを超える需要が発生した際の設備投資判断。
*   **需要セグメント (Demand Segmentation)**: B2B（サプライチェーン）、B2C（マクロ経済）、B2G（政府調達）の3層構造による需要計算。
*   **在庫と価格サイクル (Inventory & Pricing)**: 在庫過多による「値引き（デフレ）」と、供給不足による「値上げ（インフレ）」のサイクル。


## 6. 国家の市場介入 (State Market Intervention)
国家（政府・中央銀行）は、自国の経済安定や政策目標の達成を目指し、市場に対して直接的な介入を行います。これはマクロ経済指標だけでなく、プレイヤーのポジション状況にも強烈なインパクトを与えます。
詳細なロジックは [AI Ecosystem](./AI_ECOSYSTEM.md) の "National AI" セクションを参照してください。

### 6.1. 通貨・国債の売買 (Open Market Operations)
*   **通貨介入 (Currency Intervention)**:
    *   自国通貨が急激に安くなった場合（売り浴びせ）、外貨準備を取り崩して自国通貨を「買い支え」ます。
    *   逆に輸出競争力を高めるため、自国通貨を「売り」、安値誘導することもあります。
*   **国債売買 (Bond Trading)**:
    *   **買いオペ (Quantitative Easing)**: 中央銀行が市場から国債を大量に購入し、通貨供給量を増やします。これにより金利が低下し、株価にはプラス（流動性相場）に働きます。
    *   **売りオペ (Quantitative Tightening)**: 保有する国債を市場で売却し、市場から資金を吸収します。金利上昇と株価下落を招きますが、インフレ抑制には効果的です。

### 6.2. 介入のトリガー
国家AIは以下の状況で介入を検討します。
*   **為替のボラティリティ過大**: 短期間での急激な変動を嫌います。
*   **インフレ/デフレの進行**: 物価目標（例: 2%）からの乖離が大きくなった場合。
*   **国債利回りの急騰**: 国家の借金返済能力が疑われるような金利上昇に対し、利回り抑制（YCC: Yield Curve Control）を行います。
