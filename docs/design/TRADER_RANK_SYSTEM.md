# Trader Rank & Progression System Specification

## 1. 概要 (Overview)

本システムは、プレイヤーの活動量（XP）に基づいて「トレーダーランク」を決定し、経済的な優位性を付与するプログレッションシステムです。
従来の「Fee Tier」を廃止し、ランクシステムに統合します。プレイヤーは「手数料削減」と「金利優遇」を目指して日々のミッションを遂行し、生態系の頂点（Leviathan）を目指します。


## 2. ランク定義 (Rank Definitions)

ランク名は「金融市場における捕食者・生態系」をモチーフにした5段階とします。
上位ランクほど、取引手数料（Cost）と信用取引コスト（Interest）が大幅に削減されます。

### ランクマスタテーブル

| Rank ID | ランク名 (Predator) | 必要累積XP | Maker手数料 | Taker手数料 | 信用金利優遇 | 備考 |
| --- | --- | --- | --- | --- | --- | --- |
| **1** | **Shrimp** | 0 | 0.040% | 0.100% | なし | 初期状態。市場の養分。 |
| **2** | **Fish** | 2,000 | 0.020% | 0.075% | -5% | 一般大衆投資家。 |
| **3** | **Shark** | 10,000 | 0.010% | 0.050% | -10% | 獰猛なトレーダー。 |
| **4** | **Whale** | 30,000 | 0.000% | 0.025% | -20% | 市場を動かす大口。 |
| **5** | **Leviathan** | 60,000 | 0.000% | 0.000% | -50% | 伝説級の支配者。 |

* **信用金利優遇 (Interest Discount)**:
    * 信用取引（レバレッジ・空売り）にかかる日次コスト（Borrow Rate / Short Fee）に対して適用される割引率です。
    * 例: 日次金利が 0.1% の銘柄を「Leviathan」が取引する場合、コストは 0.05% になります。


## 3. XP獲得ロジック: デイリーアサインメント

ランクアップに必要なXPは、主に日々の「デイリーミッション（Daily Assignments）」から獲得します。
難易度別にペアで構成され、**「ペア完遂（セットボーナス）」**でのみXPが付与されます。

### ミッション構成 (2+2+2)

1. **Grade C: Shrimp Tasks (入門)**
    * **ターゲット**: ログイン勢、初心者
    * **内容例**: ログイン、ニュース閲覧
    * **報酬**: **+50 XP** ＋ 少額の資金


2. **Grade B: Shark Tasks (実務)**
    * **ターゲット**: 一般プレイヤー
    * **内容例**: 3回約定、2セクターへの分散投資、テクニカル指標の利用
    * **報酬**: **+150 XP**


3. **Grade A: Whale Tasks (上級)**
    * **ターゲット**: ガチ勢
    * **内容例**: 空売りでの利益確定、流動性プールへの供給、ハイレバ取引
    * **報酬**: **+500 XP**


## 4. シーズン移行と「強くてニューゲーム」

シーズン（60日）終了時、全プレイヤーの資産はリセットされますが、**前シーズンの実績に応じて次シーズンの初期XPにボーナス**が付与されます。
これにより、上級者はスタートダッシュ（手数料優遇・金利優遇を持った状態）が可能になります。

### ボーナス付与ロジック

次シーズンの初期XPは、以下の2つの要素の合計値（上限あり）で決定されます。

#### A. ランク引継ぎボーナス (Legacy Rank Bonus)

前シーズン終了時点のランクに応じて、基礎XPを付与します。

* **Ex-Leviathan**: +5,000 XP (最初から「Shark」待遇で開始可能)
* **Ex-Whale**: +2,000 XP (最初から「Fish」待遇)
* **Others**: 0 XP (「Shrimp」から開始)

#### B. ランキング入賞ボーナス (Leaderboard Bonus)

前シーズンの「総資産ランキング」上位者への追加報酬です。

* **Top 10**: +5,000 XP
* **Top 100**: +2,000 XP
* **Top 10%**: +500 XP

#### 適用例

* 前シーズン「Leviathan」かつ「ランキング3位」のプレイヤー
    * 5,000 (Rank) + 5,000 (Top10) = **10,000 XP**
* **結果**: シーズン開始直後から **Rank 3: Shark** としてスタート可能。


## 5. 計算・判定ロジック概要

### 5.1. 手数料・金利計算フロー

取引実行時および金利徴収バッチ処理時に、以下の計算を行います。

1. **ユーザー情報取得**: `users` テーブルから現在の `rank_id` を取得。
2. **マスタ参照**: `rank_master` から該当ランクの `fee_rate` と `interest_discount` を取得。
3. **コスト計算**:
    * **手数料**: `約定額 × fee_rate`
    * **金利**: `(建玉額 × 基本日次レート) × (1 - interest_discount)`
    * ※ Leviathanの場合、手数料は0、金利は半額となる。

### 5.2. ランクアップ判定フロー

XPが増加するアクション（ミッション達成、シーズン開始時のボーナス付与）が発生した瞬間に判定します。

1. **XP加算**: ユーザーの `current_xp` を更新。
2. **閾値チェック**: 現在のXPが、次のランクの `required_xp` を超えているか確認。
3. **昇格処理**:
    * 超えている場合、`rank_id` を更新。
    * クライアントへ通知（"Rank Up! You are now a Shark!"）。
    * 新しい手数料レートは即座に次回の注文から適用される。


## 6. UI/UX 要件

### プロファイル・ステータス表示

* **ランクアイコン**: プレイヤー名の横に、ランクに応じた魚/海洋生物のアイコンを表示。
* **XPバー**: 次のランクまでの進捗をプログレスバーで可視化。

### ミッション画面

* 3つのグレード（Shrimp/Shark/Whale）を並列表示。
* 「あと1つでセットボーナス獲得」を強調表示し、行動を促す。

### シーズンリザルト画面

* シーズン終了時、次シーズンの「初期ランク」と「スタートダッシュボーナス」を演出として表示。
* 「あなたの実績により、来シーズンは **Shark** として優遇された状態で開始できます」等のメッセージを表示。
